// MedEscala API Handler - Vers√£o Completa
const path = require('path');
const fs = require('fs');

module.exports = async (req, res) => {
  const timestamp = new Date().toISOString();
  console.log(`üöÄ ${timestamp} - ${req.method} ${req.url}`);

  // Configurar CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  try {
    // Rotas de privacidade sempre funcionam (fallback garantido)
    if (req.url === '/privacy' || req.url === '/privacy/') {
      return res.status(200).send(getPrivacyPage());
    }

    if (req.url === '/privacy/data-deletion' || req.url === '/privacy/data-deletion/') {
      return res.status(200).send(getDataDeletionPage());
    }

    // Tentar usar o backend NestJS para todas as outras rotas
    const possiblePaths = [
      path.join(process.cwd(), 'backend', 'dist', 'main.js'),
      path.join(__dirname, '..', 'backend', 'dist', 'main.js'),
      path.join('/var/task', 'backend', 'dist', 'main.js'),
      path.join(process.cwd(), 'dist', 'main.js'),
    ];

    let mainJsPath = null;
    for (const possiblePath of possiblePaths) {
      if (fs.existsSync(possiblePath)) {
        mainJsPath = possiblePath;
        console.log('‚úÖ Found main.js at:', mainJsPath);
        break;
      }
    }

    if (mainJsPath) {
      // Tentar carregar e usar o backend NestJS
      delete require.cache[mainJsPath]; // Limpar cache
      const { default: nestHandler } = require(mainJsPath);
      return await nestHandler(req, res);
    } else {
      console.log('‚ùå main.js not found, using fallback');
      throw new Error('Backend NestJS not found');
    }
  } catch (backendError) {
    console.log('‚ö†Ô∏è Backend error, using fallback:', backendError.message);

    // Fallback para rotas essenciais se o backend n√£o estiver dispon√≠vel
    if (
      req.url.startsWith('/users/') ||
      req.url.startsWith('/shifts/') ||
      req.url.startsWith('/contractors/') ||
      req.url.startsWith('/locations/') ||
      req.url.startsWith('/payments/') ||
      req.url.startsWith('/notifications/') ||
      req.url.startsWith('/cnpj/')
    ) {
      return res.status(503).json({
        error: 'Service Temporarily Unavailable',
        message: 'Backend NestJS n√£o encontrado. Verifique se o build foi executado corretamente.',
        timestamp,
        status: 503,
        route: req.url,
        paths_checked: [
          'backend/dist/main.js',
          '../backend/dist/main.js',
          '/var/task/backend/dist/main.js',
          'dist/main.js',
        ],
      });
    }

    // Rota raiz
    if (req.url === '/' || req.url === '') {
      return res.status(200).json({
        message: 'MedEscala API - Backend com problemas',
        timestamp,
        status: 'backend_error',
        error: backendError.message,
        routes: {
          privacy: '/privacy',
          dataDelete: '/privacy/data-deletion',
        },
      });
    }

    // Qualquer outra rota
    return res.status(404).json({
      error: 'Not Found',
      message: 'Rota n√£o encontrada. Backend NestJS indispon√≠vel.',
      timestamp,
      backend_error: backendError.message,
      availableRoutes: ['/privacy', '/privacy/data-deletion'],
    });
  }
};

function getPrivacyPage() {
  return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pol√≠tica de Privacidade - MedEscala</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .contact { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2c5aa0; }
        .update-date { color: #666; font-style: italic; background: #e9ecef; padding: 10px; border-radius: 4px; }
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; }
        a { color: #2c5aa0; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>Pol√≠tica de Privacidade - MedEscala</h1>
    <p class="update-date">üìÖ √öltima atualiza√ß√£o: 25 de junho de 2025</p>
    
    <h2>1. Informa√ß√µes que Coletamos</h2>
    <p>O MedEscala coleta as seguintes informa√ß√µes para funcionamento do aplicativo:</p>
    <ul>
        <li><strong>Dados de identifica√ß√£o:</strong> Nome completo, endere√ßo de e-mail</li>
        <li><strong>Dados profissionais:</strong> N√∫mero de registro profissional (CRM, COREN, etc.)</li>
        <li><strong>Dados de funcionamento:</strong> Informa√ß√µes sobre plant√µes, locais de trabalho, hor√°rios</li>
        <li><strong>Dados t√©cnicos:</strong> Token de dispositivo para notifica√ß√µes push</li>
    </ul>

    <h2>2. Como Usamos suas Informa√ß√µes</h2>
    <p>Utilizamos seus dados exclusivamente para:</p>
    <ul>
        <li>‚úÖ Autentica√ß√£o e acesso seguro ao aplicativo</li>
        <li>‚úÖ Gerenciamento e organiza√ß√£o de plant√µes m√©dicos</li>
        <li>‚úÖ Envio de notifica√ß√µes relacionadas aos seus plant√µes</li>
        <li>‚úÖ Melhorar a funcionalidade e experi√™ncia do aplicativo</li>
    </ul>

    <h2>3. Compartilhamento de Dados</h2>
    <p><strong>‚ùå N√ÉO vendemos, alugamos ou compartilhamos</strong> seus dados pessoais com terceiros para fins comerciais.</p>
    <p>Utilizamos apenas os seguintes servi√ßos t√©cnicos:</p>
    <ul>
        <li><strong>Clerk:</strong> Para autentica√ß√£o segura e gerenciamento de usu√°rios</li>
        <li><strong>Expo:</strong> Para envio de notifica√ß√µes push no dispositivo</li>
    </ul>

    <h2>4. Seguran√ßa dos Dados</h2>
    <p>Implementamos medidas robustas de seguran√ßa t√©cnicas e organizacionais para proteger seus dados contra:</p>
    <ul>
        <li>üîí Acesso n√£o autorizado</li>
        <li>üîí Altera√ß√£o indevida</li>
        <li>üîí Divulga√ß√£o n√£o autorizada</li>
        <li>üîí Destrui√ß√£o acidental</li>
    </ul>

    <h2>5. Seus Direitos (LGPD)</h2>
    <p>Conforme a Lei Geral de Prote√ß√£o de Dados (LGPD), voc√™ tem o direito de:</p>
    <ul>
        <li>üìã Confirmar a exist√™ncia de tratamento de dados pessoais</li>
        <li>üëÅÔ∏è Acessar seus dados pessoais</li>
        <li>‚úèÔ∏è Corrigir dados incompletos, inexatos ou desatualizados</li>
        <li>üóëÔ∏è Anonimizar, bloquear ou eliminar dados desnecess√°rios</li>
        <li>üì§ Solicitar a portabilidade dos dados</li>
        <li>‚ùå Solicitar a exclus√£o completa dos dados pessoais</li>
        <li>‚ÑπÔ∏è Obter informa√ß√µes sobre compartilhamento de dados</li>
        <li>üö´ Revogar o consentimento</li>
    </ul>

    <h2>6. Reten√ß√£o de Dados</h2>
    <p>Mantemos seus dados pessoais apenas pelo tempo:</p>
    <ul>
        <li>Necess√°rio para as finalidades descritas nesta pol√≠tica</li>
        <li>Exigido por obriga√ß√µes legais</li>
        <li>Que voc√™ mantiver sua conta ativa no aplicativo</li>
    </ul>

    <h2>7. Exclus√£o de Dados</h2>
    <p>Para solicitar a exclus√£o completa e irrevers√≠vel de seus dados:</p>
    <p>üëâ <a href="/privacy/data-deletion"><strong>Acessar Formul√°rio de Exclus√£o de Dados</strong></a></p>

    <div class="contact">
        <h2>8. Contato e Exerc√≠cio de Direitos</h2>
        <p>Para exercer qualquer um de seus direitos ou esclarecer d√∫vidas sobre esta pol√≠tica:</p>
        <p>üìß <strong>E-mail:</strong> privacidade@medescalaapp.com.br</p>
        <p>üë®‚Äçüíª <strong>Desenvolvedor:</strong> Lucas Emanuel</p>
        <p>‚è±Ô∏è <strong>Prazo de resposta:</strong> At√© 15 dias √∫teis</p>
    </div>

    <h2>9. Altera√ß√µes nesta Pol√≠tica</h2>
    <p>Esta pol√≠tica pode ser atualizada periodicamente para refletir mudan√ßas em nossas pr√°ticas ou na legisla√ß√£o. Recomendamos que voc√™ revise esta p√°gina regularmente.</p>
    
    <p><strong>Vers√£o:</strong> 2.0 | <strong>Vig√™ncia:</strong> 25 de junho de 2025</p>
</body>
</html>`;
}

function getDataDeletionPage() {
  return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclus√£o de Dados - MedEscala</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .form-container { background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.1); }
        textarea { height: 100px; resize: vertical; }
        .btn { background: #e74c3c; color: white; padding: 14px 28px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.2s; }
        .btn:hover { background: #c0392b; }
        .warning-box { background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #f39c12; }
        .info-box { background: #e8f4fd; border: 1px solid #bee5eb; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #17a2b8; }
        .back-link { display: inline-block; margin-top: 20px; color: #2c5aa0; text-decoration: none; font-weight: 500; }
        .back-link:hover { text-decoration: underline; }
        .process-step { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid #28a745; }
        ol { counter-reset: step-counter; }
        ol li { counter-increment: step-counter; margin-bottom: 15px; }
        ol li::marker { content: counter(step-counter) ". "; font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body>
    <h1>üóëÔ∏è Solicita√ß√£o de Exclus√£o de Dados</h1>
    
    <div class="warning-box">
        <h3>‚ö†Ô∏è ATEN√á√ÉO: A√ß√£o Irrevers√≠vel</h3>
        <p>A exclus√£o dos dados √© <strong>permanente e irrevers√≠vel</strong>. Ap√≥s a confirma√ß√£o:</p>
        <ul>
            <li>‚ùå Todos os seus dados pessoais ser√£o permanentemente removidos</li>
            <li>‚ùå Voc√™ perder√° acesso completo ao aplicativo MedEscala</li>
            <li>‚ùå Todos os plant√µes, configura√ß√µes e hist√≥rico ser√£o deletados</li>
            <li>‚ùå N√£o ser√° poss√≠vel recuperar nenhuma informa√ß√£o</li>
            <li>‚è±Ô∏è O processo pode levar at√© 30 dias corridos para ser conclu√≠do</li>
        </ul>
    </div>

    <div class="form-container">
        <h2>üìù Formul√°rio de Solicita√ß√£o</h2>
        <p>Preencha os dados abaixo para solicitar a exclus√£o de seus dados:</p>
        
        <form action="mailto:privacidade@medescalaapp.com.br" method="post" enctype="text/plain">
            <div class="form-group">
                <label for="email">üìß E-mail cadastrado no MedEscala: *</label>
                <input type="email" id="email" name="email" required placeholder="seu.email@exemplo.com">
            </div>
            
            <div class="form-group">
                <label for="nome">üë§ Nome completo: *</label>
                <input type="text" id="nome" name="nome" required placeholder="Seu nome completo conforme cadastrado">
            </div>
            
            <div class="form-group">
                <label for="registro">üè• Registro profissional (CRM/COREN): *</label>
                <input type="text" id="registro" name="registro" required placeholder="Ex: CRM 12345-SP">
            </div>
            
            <div class="form-group">
                <label for="motivo">üí≠ Motivo da exclus√£o (opcional):</label>
                <textarea id="motivo" name="motivo" placeholder="Conte-nos o motivo para nos ajudar a melhorar nossos servi√ßos (opcional)"></textarea>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" required style="width: auto;"> 
                    <span>‚úÖ Confirmo que entendo que esta a√ß√£o √© <strong>irrevers√≠vel</strong> e todos os meus dados ser√£o <strong>permanentemente exclu√≠dos</strong>.</span>
                </label>
            </div>
            
            <button type="submit" class="btn">üóëÔ∏è Solicitar Exclus√£o de Dados</button>
        </form>
    </div>
        
    <div class="info-box">
        <h4>üìß M√©todo Alternativo</h4>
        <p>Voc√™ tamb√©m pode enviar um e-mail diretamente para:</p>
        <p><strong>üì¨ privacidade@medescalaapp.com.br</strong></p>
        <p><strong>üìã Assunto:</strong> "Solicita√ß√£o de Exclus√£o de Dados - [SEU NOME]"</p>
        <p><strong>üìù Conte√∫do:</strong> Inclua seu e-mail cadastrado, nome completo, registro profissional e solicita√ß√£o de exclus√£o.</p>
    </div>

    <h2>üîÑ Processo de Exclus√£o</h2>
    <ol>
        <li class="process-step">
            <strong>üì§ Solicita√ß√£o:</strong> Preencha o formul√°rio acima ou envie um e-mail
            <br><small>‚è±Ô∏è Prazo: Imediato</small>
        </li>
        <li class="process-step">
            <strong>üîç Verifica√ß√£o:</strong> Confirmaremos sua identidade e validaremos a solicita√ß√£o
            <br><small>‚è±Ô∏è Prazo: 2 a 5 dias √∫teis</small>
        </li>
        <li class="process-step">
            <strong>‚öôÔ∏è Processamento:</strong> Iniciaremos a exclus√£o permanente dos dados de todos os sistemas
            <br><small>‚è±Ô∏è Prazo: At√© 30 dias corridos</small>
        </li>
        <li class="process-step">
            <strong>‚úÖ Confirma√ß√£o:</strong> Voc√™ receber√° uma confirma√ß√£o final quando o processo for conclu√≠do
            <br><small>‚è±Ô∏è Prazo: Ap√≥s conclus√£o do processamento</small>
        </li>
    </ol>

    <h2>‚ùì D√∫vidas ou Problemas?</h2>
    <div class="info-box">
        <p>Se voc√™ tiver d√∫vidas sobre o processo ou encontrar algum problema:</p>
        <ul>
            <li>üìß <strong>E-mail:</strong> privacidade@medescalaapp.com.br</li>
            <li>üìã <strong>Assunto:</strong> "D√∫vidas sobre Exclus√£o de Dados"</li>
            <li>‚è±Ô∏è <strong>Tempo de resposta:</strong> At√© 15 dias √∫teis</li>
        </ul>
    </div>

    <a href="/privacy" class="back-link">‚Üê Voltar para Pol√≠tica de Privacidade</a>
    
    <hr style="margin: 40px 0; border: none; border-top: 1px solid #dee2e6;">
    <p style="text-align: center; color: #6c757d; font-size: 14px;">
        MedEscala ¬© 2025 | Desenvolvido por Lucas Emanuel
    </p>
</body>
</html>`;
}
