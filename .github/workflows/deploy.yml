name: ðŸš€ Auto Deploy to Vercel

on:
  push:
    branches: [master, main]
  workflow_dispatch: # Permite deploy manual

env:
  NODE_VERSION: 18

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Debug - Check secrets
        run: |
          echo "ðŸ” Checking if secrets are configured..."
          if [ -z "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            echo "âŒ VERCEL_DEPLOY_HOOK secret not configured"
            echo "ðŸ“ Please configure the following secrets in your GitHub repository:"
            echo "   - VERCEL_DEPLOY_HOOK (Vercel webhook URL)"
            echo "   - VERCEL_URL (optional - your app URL)"
            exit 1
          else
            echo "âœ… VERCEL_DEPLOY_HOOK secret is configured"
          fi

      - name: ðŸš€ Trigger Vercel Deploy
        run: |
          echo "ðŸš€ Triggering Vercel deployment..."
          echo "ðŸ“… Timestamp: $(date)"
          echo "ðŸ·ï¸  Commit: ${{ github.sha }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"

          # Fazer a requisiÃ§Ã£o com timeout
          response=$(curl -s -w "%{http_code}" -X POST \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            "${{ secrets.VERCEL_DEPLOY_HOOK }}")

          http_code="${response: -3}"
          body="${response%???}"

          echo "ðŸ“¡ HTTP Status Code: $http_code"

          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            echo "âœ… Deploy triggered successfully!"
            echo "ðŸŒ Check your Vercel dashboard for deployment progress"
            if [ -n "${{ secrets.VERCEL_URL }}" ]; then
              echo "ðŸ“± Your app will be available at: ${{ secrets.VERCEL_URL }}"
            fi
          else
            echo "âŒ Deploy failed with status: $http_code"
            echo "ðŸ“„ Response body: $body"
            exit 1
          fi

      - name: ðŸ“ Deploy Summary
        if: always()
        run: |
          echo "## ðŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Status:** âœ… Deploy triggered successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âŒ Deploy failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "If the deploy failed, check:" >> $GITHUB_STEP_SUMMARY
          echo "1. VERCEL_DEPLOY_HOOK secret is correctly configured" >> $GITHUB_STEP_SUMMARY
          echo "2. Webhook URL is valid and accessible" >> $GITHUB_STEP_SUMMARY
          echo "3. Vercel project is properly connected" >> $GITHUB_STEP_SUMMARY
