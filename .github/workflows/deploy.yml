name: ðŸš€ Auto Deploy to Vercel (Empresa)

on:
  push:
    branches: [master, main]
  workflow_dispatch: # Permite deploy manual

env:
  NODE_VERSION: 18

jobs:
  deploy:
    name: Deploy to Vercel (Empresa)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Trigger Vercel Deploy
        run: |
          echo "ðŸš€ Triggering Vercel deployment via company webhook..."
          echo "ðŸ“… Timestamp: $(date)"
          echo "ðŸ·ï¸  Commit: ${{ github.sha }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"

          # Fazer a requisiÃ§Ã£o com timeout
          response=$(curl -s -w "%{http_code}" -X POST \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            "https://api.vercel.com/v1/integrations/deploy/prj_r2kjmLat72JKWzehRSae3Kuvb8Cd/7b38KFTLvM")

          http_code="${response: -3}"
          body="${response%???}"

          echo "ðŸ“¡ HTTP Status Code: $http_code"

          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            echo "âœ… Deploy triggered successfully!"
            echo "ðŸ“„ Response: $body"
            echo "ðŸŒ Check the company's Vercel dashboard for deployment progress"
          else
            echo "âŒ Deploy failed with status: $http_code"
            echo "ðŸ“„ Response body: $body"
            exit 1
          fi

      - name: ðŸ“ Deploy Summary
        if: always()
        run: |
          echo "## ðŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Status:** âœ… Deploy triggered successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âŒ Deploy failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Company Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Deploy triggered on company's Vercel account." >> $GITHUB_STEP_SUMMARY
          echo "Check the deployment progress on the company dashboard." >> $GITHUB_STEP_SUMMARY
